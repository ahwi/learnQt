## 第8章 绘图



本章简介：

* 界面上的各个组件都是通过绘图而得到的。

* Qt的二维绘图基本功能是通过QPainter在绘制设备上绘图实现的，通过绘制一些点、线、面等基本图形组成自己需要的图形，得到的图形是不可交互操作的图形。
  * 绘图设备包括：
    * QWidget
    * QPixmap
* Qt还提供了Graphics View框架，使用QGraphicsView、QGraphicsScense、QGraphicsItem类来绘制图形，在一个场景中可以绘制大量图件，且每个图件都是可选择、可交互的。

本章先介绍QPainter绘图的原理，再介绍Graphics View架构

### 8.1 QPainter基本绘图

#### 8.1.1 QPainter绘图系统

##### 1. QPainter与QPaintDevice

Qt的绘图系统使用户可以在屏幕或打印设备上用相同的API绘图，绘图系统基于三个类：

* QPainter

  QPainter用来进行绘图操作的类

* QPaintDevice

  一个可以使用QPainter进行绘图的抽象的二维界面

  一般的绘图设备包括QWidget、QPixmap、QImage等，这些设备为QPainter提供一个"画布"

* QPaintEngine

  给QPainter提供在不同设备上绘图的接口

  QPaintEngine类由QPainter和QPaintDevice内部使用，应用程序一般无需和QPaintEngine打交道，除非要创建自己的设备类型。

##### 2. paintEvent事件和绘图区

要在设备上绘图，只需要重新实现`paintEvent`事件并在上面编写响应代码。创建一个QPainter对象获取绘图设备的接口，然后就可以在绘图设备的"画布"上绘图了。

在`paintEvent()`事件里绘图的基本程序结构是：

```c++
void Widget::paintEvent(QPaintEvent *event)
{
    QPainter painter(this);	//创建与绘图设备关联的QPainter对象
    ...//painter在设备的窗口上画图
}
```

QWidget的绘图区就是其窗口内部区域

![image-20221121091004788](qt5.9 C++开发指南.assets/image-20221121091004788.png)

QWidget的内部绘图区的坐标系统如图8-1所示

* 坐标系统的单位是像素
* 左上角坐标为(0,0)，向右是X轴正方向，向下是Y轴正方向
* 绘图区的宽度和高度分别由`QWidget::width()`和`QWidget::height()`函数获取。
* 这个坐标系统是QWidget绘图区的局部物理坐标，称为视口（viewport）坐标，相应的还有逻辑坐标，称为窗口（window）坐标

##### 3. QPainter绘图的主要属性

QPainter主要的三个属性：

* pen(QPen对象)

  用于控制线条的颜色、宽度、线型等

* brush(QBrush对象)

  用于设置一个区域的填充特性，可以设置填充颜色、填充方式、渐变特性等，还可以采用图片做材质填充。

* font(QFont对象)

  用于绘制文字时，设置文字的字体样式、大小等属性

> 使用这3个属性基本就控制了绘图的基本特点，当然还有一些其他的功能结合使用，比如叠加模式、旋转和缩放等功能。



==============待完善========================

##### 4. 创建实例

实例`samp8_1`演示:使用`paintEvent()`时间来绘图

#### 8.1.2 QPen的主要功能

#### 8.1.3 QBrush的主要功能

#### 8.1.4 渐变填充

#### 8.1.5 QPainter绘制基本图形元件

### 8.2 坐标系统和坐标变换

#### 8.2.1 坐标变换函数

![image-20221121091004788](qt5.9 C++开发指南.assets/image-20221121091004788.png)

* QPainter在窗口上绘图的默认坐标系统如图8-1所示，这是绘图设备的物理坐标
* 为了绘图的方便，QPainter提供了一些坐标变换的功能，通过平移、旋转等坐标变换，得到一个逻辑坐标系统

坐标变换函数见表8-5：

![image-20221122143433764](qt5.9 C++开发指南.assets/image-20221122143433764.png)

* 常用的坐标变换是平移、旋转和缩放
* 使用世界坐标变换矩阵也可以实现这些变换功能，但是需要单独定义一个QTransform类的变量，对于QPainter来说，简单的坐标变换使用QPainter自由的坐标变换函数就足够了。

##### 1. 坐标平移

坐标平移函数`void tanslate(qreal dx, qreal dy)`

* 将坐标系统水平方向平移dx个单位，垂直方向移动dy个单位，在缺少的坐标系统中，单位就是像素。
* 如果是从原始状态平移(dx,dy)，那么平移后的坐标原点就移到了(dx,dy)

举例：假设一个绘图窗口的宽度为300像素，高度为200像素，则其坐标系统如图8-10左所示，若执行平移函数`translate(150,100)`，则坐标系统水平向右平移150像素，平移后的坐标系统如图8-10右所示，坐标原点在窗口的中心，而左上角的坐标变为(-150,-100)，右下角的坐标变为(150,100)。。

![image-20221122164516812](qt5.9 C++开发指南.assets/image-20221122164516812.png)

##### 2. 坐标旋转

坐标旋转`void rotate(qreal angle)`

* 将坐标系统绕坐标原点顺时针旋转angle角度，单位是度。
* angle为正 顺时针旋转，为负 逆时针旋转

示例：如上图所示，在图8-10右的基础上，若执行`rotate(90)`，则得到图8-11所示的坐标系统。在8-11的新坐标系下，窗口左上角的坐标变成了(-100,150)，而右下角的坐标变成了(100, -150)

> 注：旋转之后并不会改变窗口矩形的实际大小，只是改变了坐标轴的方向。

##### 3. 缩放

缩放函数`void scale(qreal sx, qreal sy)`

sx,sy分别为横向和纵向缩放比例，比例大于1是放大，小于1是缩小。

##### 4. 状态保持与恢复

进行坐标变换时，QPainter内部实际上有一个坐标变换矩形

* `save()`：保存当前坐标状态
* `restore()`：恢复上次保存的坐标状态

这两个函数必须配对使用，操作的是同一个堆栈对象。

* `resetTransform()`：复位所有坐标变换操作，恢复原始的坐标系统。

#### 8.2.2 坐标变换绘图示例

##### 1. 绘制3个五角星的程序

略

##### 2. 绘制五角星的PainterPath的定义

略

#### 8.2.3 视口和窗口

##### 1. 视口和窗口的定义与原理

绘图设备的物理坐标是基本的坐标系，通过QPainter的平移等变换得到更容易操作的逻辑坐标。

为了实现更方便的坐标，QPainter还提供了视口（Viewport）和窗口（Window）坐标系，通过QPainter内部的坐标变换矩阵自动转换为绘图设备的物理坐标。

* 视口

  * 表示绘图设备的任意一个矩形区域的物理坐标，可以只选取物理坐标的一个矩形区域用于绘图。
  * 默认情况下，视口等于绘图设备的整个矩形区。

* 窗口

  * 与视口是同一个矩形，只不过是用逻辑坐标定义的坐标系。

  * 窗口可以直接定义矩形区的逻辑坐标范围。

图8-13是对视口和窗口的图示说明

![image-20221122172224678](qt5.9 C++开发指南.assets/image-20221122172224678.png)

* 图8-13左图中的矩形框代表绘制设备的物理大小和坐标范围，宽度为300像素，高度为200像素

* 取其中间的一个正方形区域作为视口，灰色的正方形就是视口，绘制设备的物理坐标中，视口的左上角坐标为(50,0)，右下角坐标为(250,200)。
  * 定义此视口，使用`painter.setViewport(50,0,200,200)`
  * 表示从绘制设备物理坐标系统的起点(50,0)开始，取宽度为200、高度为200的一个矩形区域作为视口。
* 对于图8-13左图的视口所表示的正方形区域，定义一个窗口（图8-13右图），窗口坐标的中心在正方形中心，并设置正方形的逻辑边长为100。
  * 定义此窗口，使用`painter.setWindow(-50,-50,100,100)`
  * 它表示对应于视口的矩形区域，其窗口左上角的逻辑坐标是(-50,-50)，窗口宽度为100，高度为100。
  * 这里设置的窗口还是一个正方形，使得从视口到窗口变换时，长和宽的变化比例是相同的。实际可以任意指定窗口的逻辑坐标范围，长和宽的变化比例不相同也是可以的。

##### 2. 视口和窗口的使用实例

略

#### 8.2.4 绘图叠加的效果

略

### 8.3 Graphics View绘图架构

#### 8.3.1 场景、视图与图形项

QPainter绘图：

* 需要在绘图设备的`paintEvent()`事件里编写绘图程序，实现整个绘图过程
* 这种方法绘制的图形是位图
* 这种方法适合用于绘制复杂性不高的固定图形
* 不能实现图件的选择、编辑、拖放等功能。

Graphics View绘图架构：

* 绘制复杂的可交互图像
* 一种基于图形项（Graphics Item）的模型/视图模式
* 使用该架构可以绘制复杂的、有几万个基本图形元件的图形，并且每个图形元件是可选择、可拖放和修改的，类似于矢量绘图软件的绘图功能。

![image-20221124085902485](qt5.9 C++开发指南.assets/image-20221124085902485.png)

Graphics View架构主要由3个部分组成：

* 场景（Scene）

  场景是不可见的，是一个抽象的管理图形项的容器，可以向场景添加图形项、获取场景中的某个图形项等。场景主要具有如下一些功能：

  * 提供管理大量图形项的快速接口

  * 将事件传播给每个图形项

  * 管理每个图形项的状态，如选择状态、焦点状态等

  * 管理未经变换的渲染功能，主要用于打印

  * 其他：

    * 背景层和前景层

      通常由QBrush指定，也可以通过实现`drawBackground()`和`drawForeground()`函数来实现自定义的背景和前景，实现一些特殊效果。

* 视图（View）

  用于显示场景中的内容，可以为一个场景设置几个视图，用于对同一个数据集提供不同的视口。

  * 视图接受键盘和鼠标输入并转换为场景事件，并进行坐标转换后传送给可视场景。

* 图形项（Graphics Item）

  一些基本的图形元件，图形项的基类是QGraphicsItem。Qt提供了一些基本的图形项，如绘制椭圆的QGraphicsEllipseItem、绘制矩形的QGraphicsRectItem等。

  QGraphicsItem支持如下的一些操作：

  * 支持鼠标事件响应，包括鼠标按下、移动、释放、双击，还有鼠标的停留、滚轮、快捷菜单等事件
  * 支持键盘输入、按键事件
  * 支持拖放操作
  * 支持组合，可以是父子项关系组合，也可以是通过QGraphicsItemGroup类进行组合。
  * 支持碰撞检测

三者的关系：场景是图形项的容器，可以在场景上绘制很多图形项，每个图形项就是一个对象，视图是显示场景的一部分区域的视口，一个场景可以有多个视图，一个视图显示场景的部分区域或全部区域，或从不同角度观察场景。

#### 8.3.2 Graphics View的系统坐标

![image-20221128084802431](qt5.9 C++开发指南.assets/image-20221128084802431.png)

Graphics View系统有3个坐标系：

* 图形项坐标

  * 图像坐标是局部的逻辑坐标，一般以图件的中心为原点(0,0)，也是各种坐标变换的中心。
  * 图形项的鼠标事件的坐标是用局部坐标表示的，创建自定义图形项，绘制图形项时只需考虑其局部坐标，QGraphicsScene和QGraphicsView会自动进行坐标转换。
  * 一个图形项的位置是器中心点在父坐标系统中的坐标，对于没有父图形项的图形项，其父对象就是场景，图形项的位置就是在场景中的坐标。
  * 如果一个图形项还是其他图形项的父项，父项进行坐标变换时，子项也做同样的坐标变换。
  * QGraphicsItem大多数函数都是在其局部坐标系上操作的，例如图形项的边界矩形`QGraphicsItem::boundingRect()`是用局部坐标给出的，但是`QGraphicsItem::post()`是仅有的几个例外，返回的是图形项在父项坐标系中的坐标，如果是顶层图形项，就是在场景中的坐标。

* 场景坐标（Scene Coordinates）

  * 场景的坐标等价于QPainter的逻辑坐标，一般以场景的中心为原点

  * 场景是所有图形项的基础坐标，描述了每个顶层图形项的位置。

  * 创建场景时可以定义场景矩形区域的坐标范围，如`scene=new QGraphicsScene(-400, -300, 800, 600)`

    这样定义的scene是左上角坐标为(-400,-300)，宽度为800，高度为600的矩形区域，单位是像素。

  * 每个图形项在场景里都有一个位置坐标 `QGraphicsItem::scenePos()`给出

  * 图形项的边界矩形 `QGraphicsItem::sceneBoundingRect()`函数给出，边界矩形可以使`QGraphicsScene`知道场景的哪个区域发生了变化，场景发生变化会发射`QGraphicsScene::changed()`信号，参数是一个场景的矩形列表，表示发生变化的矩形区。

* 视图坐标（View Coordinates）

  * 视图坐标与设备坐标相同（窗口界面widget的物理坐标），是物理坐标，缺省以左上角为原点，单位是像素，视图坐标只与widget或视口有关，而与观察的场景无关。
  * 所有的鼠标、拖放事件的坐标首先是由视图坐标定义的，然后用户需要将这些坐标映射为场景坐标，以便和图形项交互。

**坐标映射**

坐标映射：在场景操作图形项时，进行场景到图形项、图形项到图形项，或视图到场景之间的坐标变换时比较有用的。

例如，在QGraphicsView的视口上单击鼠标时，通过函数`QGraphicsView::mapToScene()`可以将视图坐标映射为场景坐标，然后用`QGraphicsScene::itemAt()`获取场景中鼠标光标处的图形项。

#### 8.3.3 Graphics View相关的类

##### 1. QGraphics View类的主要接口函数

QGraphics View的视口坐标等于显示设备的物理坐标，但也可以对QGraphicsView的坐标进行平移、旋转、缩放等变换。

主要的函数：

![image-20221128190438069](qt5.9 C++开发指南.assets/image-20221128190438069.png)

##### 2. QGraphicsScene类的主要接口函数

QGraphicsScene的主要接口函数：

![image-20221128190550233](qt5.9 C++开发指南.assets/image-20221128190550233.png)

##### 3. 图形项

QGraphicsItem是所有图形项的基类，用户也可以从QGraphicsItem继承定义自己的图形项。

图形项的类的继承关系如下图：

![image-20221128190725661](qt5.9 C++开发指南.assets/image-20221128190725661.png)

QGraphicsItem类提供的图形项操作的函数

![image-20221128190805682](qt5.9 C++开发指南.assets/image-20221128190805682.png)

#### 8.3.4 Graphics View程序基本结构和功能实现

实例samp8_4，主要功能包括以下几点：

* 工作区是一个从QGraphicsView继承的自定义类QWGraphicsView，作为绘图的视图组件
* 创建一个QGraphicsScene场景，场景的大小就是途中的实线矩形框的大小
* 改变窗口大小，当视图大于场景时，矩形框总是居于图形视图的中央；当视图小于场景时，在视图窗口自动出现卷滚条。
* 蓝色椭圆正好处于场景的中间，红色圆形位于场景的右下角。当图形项位置不在场景的矩形框中时，图形项也是可以显示的。
* 当鼠标在窗口上移动时，会在状态栏显示当前光标位置的视图坐标和场景坐标，在某个图形项上单击鼠标时，还好显示在图形项中的局部坐标。

这个实例演示视图、场景和绘图项3个坐标系的关系，已经它们之间的坐标转换。



<img src="qt5.9 C++开发指南.assets/image-20221128191317945.png" alt="image-20221128191317945" style="zoom: 67%;" />

#### 8.3.5 Graphics View绘图程序

samp8_5：一个基于Graphics View结构的简单绘图程序，通过这个实例可以发现Graphics View图形编程更多功能的使用方法。

运行界面如下图所示：

![image-20221128192610151](qt5.9 C++开发指南.assets/image-20221128192610151.png)

其他：略



## 第9章 Qt Charts

Qt Charts可以方便地绘制常见的折线图、柱状图、饼图等图表。

本章主要介绍：

* Qt Charts的基本特点和功能
* 以画折线图为例详细说明Qt Charts各主要部件的操作方法
* 介绍各种常用图标的绘图方法
* 介绍鼠标操作图形缩放等功能的实现

> Qt 5.7以前只有商业版才有Qt Charts，5.7以后社区版本也包含了Qt Charts

### 9.1 Qt Charts概述

#### 9.1.1 Qt Charts模块

Qt Charts模块是一组易于使用的图标组件，它基于Qt的Graphics View架构，其核心组件是QChartView和QChart。

* QChartView用于显示图表的视图，其父类是QGraphicsView

* QChart的继承关系：

  ![image-20221128194402466](qt5.9 C++开发指南.assets/image-20221128194402466.png)

  * QChart是一种图形项。
  * QPolarChart是用于绘制极坐标图的图表类。

* 在项目中使用Qt Charts模块：

  * 在配置文件（.pro文件）中增加下面的一行语句

    ```c++
    Qt += charts
    ```

  * 在需要使用QtCharts的类的头文件或源程序文件中，使用包含语句

    ```c++
    #include <QtCharts>
    using namespace QtCharts;
    ```

    也可以使用宏定义

    ```c++
    #include <QtCharts>
    Qt_CHARTS_USE_NAMESPACE
    ```

#### 9.1.2 一个简单的QChart绘图程序



























